name: Streamlit CD
on:
  workflow_run:
    workflows: ["CI Workflow"]  # Ex√©cute seulement si le workflow CI a √©t√© ex√©cut√©
    types:
      - completed
    branches:
      - main

env:
  DOCKER_IMAGE: prediction_donnees_immobilieres-streamlit_app
  CONTAINER_NAME: prediction_donnees_immobilieres-streamlit_app-1
  PORT: 8501

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v3

      - name: üê≥ Installation de Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io docker-compose tmux

      - name: üî® Construction de l'image Docker
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }} .

      - name: üöÄ D√©marrage du conteneur en arri√®re-plan
        run: |
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true
          tmux new-session -d -s streamlit_app "docker run --rm -p ${{ env.PORT }}:${{ env.PORT }} --name ${{ env.CONTAINER_NAME }} ${{ env.DOCKER_IMAGE }}"

      - name: üõ†Ô∏è V√©rification que l'application est en ligne
        run: |
          echo "Attente de l'application sur le port ${{ env.PORT }}..."
          for i in {1..12}; do
            if curl -s http://localhost:${{ env.PORT }} >/dev/null; then
              echo "L'application est en ligne !"
              exit 0
            fi
            echo "Tentative $i : l'application n'est pas encore en ligne, attente de 5 secondes..."
            sleep 5
          done
          echo "L'application n'est toujours pas en ligne apr√®s 60 secondes."
          exit 1

      - name: üåç Installation et configuration de Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update && sudo apt-get install -y ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: üîó D√©marrage de Ngrok en arri√®re-plan
        run: |
          tmux new-session -d -s ngrok "ngrok http ${{ env.PORT }}"

      - name: üîé V√©rification de Ngrok et affichage du lien
        run: |
          echo "Attente de l'√©tablissement du tunnel Ngrok..."
          for i in {1..10}; do
            NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url' 2>/dev/null)
            if [[ -n "$NGROK_URL" && "$NGROK_URL" != "null" ]]; then
              echo "Tunnel Ngrok disponible : $NGROK_URL"
              echo "Lien de l'application : $NGROK_URL"
              exit 0
            fi
            echo "Tentative $i : Ngrok n'a pas encore g√©n√©r√© d'URL, attente de 5 secondes..."
            sleep 5
          done
          echo "√âchec de la g√©n√©ration du lien Ngrok apr√®s plusieurs tentatives."
          exit 1
